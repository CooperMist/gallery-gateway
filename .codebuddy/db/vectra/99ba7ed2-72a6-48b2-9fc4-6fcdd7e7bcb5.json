{"chunk":0,"numChunks":1,"fileHash":"Sy5/bdNIs8gXQDm7uJZQsdxZz/6ZPLWdpKlM+BDrxFU=","filePath":"backend/test/setup.js","content":"import Uzmug from 'umzug'\r\n\r\nimport User from '../models/user'\r\nimport Show from '../models/show'\r\nimport Entry from '../models/entry'\r\nimport Group from '../models/group'\r\nimport Image from '../models/image'\r\nimport Video from '../models/video'\r\nimport Other from '../models/other'\r\nimport Vote from '../models/vote'\r\nimport db from '../config/sequelize'\r\n\r\nbefore(function () {\r\n  const uzmug = new Uzmug({\r\n    storage: 'sequelize',\r\n    storageOptions: {\r\n      sequelize: db\r\n    },\r\n    logging: console.log,\r\n    migrations: {\r\n      params: [ db.getQueryInterface(), db.Sequelize ],\r\n      path: './db/migrations'\r\n    }\r\n  })\r\n  return db.transaction(transaction =>\r\n    db.query('SET FOREIGN_KEY_CHECKS = 0', {transaction})\r\n      .then(() =>\r\n        db.dropAllSchemas({transaction})\r\n      )\r\n      .then(() => {\r\n        return db.query('SET FOREIGN_KEY_CHECKS = 1', {transaction})\r\n      })\r\n  )\r\n    .then(() => uzmug.up())\r\n})\r\n\r\nbeforeEach(function () {\r\n  return db.transaction((t) => {\r\n    return db.query('SET FOREIGN_KEY_CHECKS = 0', {transaction: t})\r\n      .then(() => {\r\n        return Promise.all(\r\n          [User, Show, Entry, Group, Image, Video, Other, Vote]\r\n            .map((model) => model.destroy({where: {}, transaction: t}))\r\n        )\r\n      })\r\n      .then(() => {\r\n        return db.query('SET FOREIGN_KEY_CHECKS = 1', {transaction: t})\r\n      })\r\n  })\r\n})\r\n\r\nafter(function () {\r\n  return db.close()\r\n})\r\n"}