{"chunk":0,"numChunks":1,"fileHash":"J+VqVAeDD7AquxOXQw477eRk/gUjvWUMkPmgII+TIQ8=","filePath":"backend/resolvers/queries/ratingQuery.js","content":"import PortfolioRatings from '../../models/portfolioRating'\r\nimport Portfolio from '../../models/portfolio'\r\n\r\nimport { UserError } from 'graphql-errors'\r\nimport { ADMIN, JUDGE } from '../../constants'\r\n\r\nexport function ratings (_, args, context) {\r\n  console.log(\"Reached fetch ratings\")\r\n  const isRequestingOwnJudgeUser = context.username !== undefined &&\r\n    context.authType === JUDGE && context.username === args.judgeUsername\r\n  if (context.authType !== ADMIN && !isRequestingOwnJudgeUser) {\r\n    throw new UserError('Permission Denied')\r\n  }\r\n  //return all of a judges ratings for a given portfolio period\r\n  return Portfolio.findAll({\r\n    where: {\r\n      portfolioPeriodId: args.portfolioPeriodId }\r\n    }).then((portfolios) => {\r\n      const portfolioIds = portfolios.map(portfolio => portfolio.id)\r\n      return getRatings(args.judgeUsername, context.authType, portfolioIds)\r\n  })\r\n}\r\n\r\nexport function rating (_, args, context) {\r\n  const isRequestingOwnJudgeUser = context.username !== undefined &&\r\n    context.authType === JUDGE && context.username === args.judgeUsername\r\n  if (context.authType !== ADMIN && !isRequestingOwnJudgeUser) {\r\n    throw new UserError('Permission Denied')\r\n  }\r\n  return PortfolioRatings.findOne({\r\n    where: {\r\n      judgeUsername: args.judgeUsername,\r\n      portfolioId: args.portfolioId\r\n    }\r\n  })\r\n}\r\n\r\nfunction getRatings (username, authType, portfolioIds) {\r\n  // Give all ratings on the portfolio period if the user\r\n  // is an admin and username was not given\r\n  if (authType === ADMIN && !username) {\r\n    return PortfolioRatings.findAll({\r\n      where: { portfolioId: portfolioIds }\r\n    })\r\n  } else {\r\n    // Return the ratings only for the given judge\r\n    return PortfolioRatings.findAll({\r\n      where: {\r\n        judgeUsername: username,\r\n        portfolioId: portfolioIds\r\n      }\r\n    })\r\n  }\r\n}"}